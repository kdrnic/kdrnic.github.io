<html><head data-created="2023-05-14T20:37:14.608Z" data-modified="2023-05-14T20:37:07.842Z"><meta charset="UTF8"><link rel="stylesheet" href="hlstyles/default.css"><link rel="stylesheet" href="motherfucker.css"></head><body data-title="256-byte x86 fire demo"><div class="article-index"><ul data-type="pages_index"><li><span>&apos;23/06/03 23:20   </span><a target="_top" href="index_kdrgbtags.html">kdrgbtags, a ctags-style tool for RGBDS</a></li><li><span>&apos;23/06/03 22:37   </span><a target="_top" href="index_gbasm.html">GB Assembly Test</a></li><li><span>&apos;23/05/14 20:37   </span><a target="_top" href="index_firedemo.html">256-byte x86 fire demo</a></li><li><span>&apos;23/04/29 22:19   </span><a target="_top" href="index_b17.html">Reverse engineering a DOS game B17 Flying Fortress</a></li><li><span>&apos;22/01/03 23:33   </span><a target="_top" href="index_c64floats.html">C++ Commodore 64 floating point library</a></li><li><span>&apos;21/07/24 21:25   </span><a target="_top" href="index_OPL.html">OPL3 MIDI player</a></li><li><span>&apos;20/12/06 22:27   </span><a target="_top" href="index_gifcap.html">gifcap library</a></li><li><span>&apos;20/08/01 21:53   </span><a target="_top" href="index_doomloader.html">Doom level loader</a></li><li><span>&apos;19/11/19 06:06   </span><a target="_top" href="index_nesem3.html">NES Emulation Saga Part III</a></li><li><span>&apos;19/11/19 06:06   </span><a target="_top" href="index_nesem2.html">NES Emulation Saga Part II</a></li><li><span>&apos;19/11/19 06:06   </span><a target="_top" href="index_nesem1.html">NES Emulation Saga Part I</a></li><li><span>&apos;19/10/31 02:37   </span><a target="_top" href="index_kym.html">&#x1F3AE; Kori Yogan Mushi</a></li><li><span>&apos;19/08/03 20:43   </span><a target="_top" href="index_bespoke.html">&#x1F3AE; Bespoke Terror</a></li><li><span>&apos;19/08/03 20:32   </span><a target="_top" href="index_1hgj8.html">&#x1F3AE; Conker&apos;s BFD for Nintendo 486</a></li><li><span>&apos;19/07/23 22:18   </span><a target="_top" href="index_trog.html">&#x1F3AE; TROG</a></li><li><span>&apos;19/07/23 22:18   </span><a target="_top" href="index_stacker.html">&#x1F3AE; TTY Stacker</a></li><li><span>&apos;19/07/23 22:18   </span><a target="_top" href="index_snake.html">&#x1F3AE; Snake</a></li><li><span>&apos;19/07/23 22:18   </span><a target="_top" href="index_sm64.html">&#x1F3AE; SM64 HTML5</a></li><li><span>&apos;19/07/23 22:18   </span><a target="_top" href="index_ronaldo.html">&#x1F3AE; 3D Ronaldo Football</a></li><li><span>&apos;19/07/23 22:18   </span><a target="_top" href="index_roguelike.html">&#x1F3AE; Batch Roguelike</a></li><li><span>&apos;19/07/23 22:18   </span><a target="_top" href="index_prototype.html">&#x1F3AE; Prototype</a></li><li><span>&apos;19/07/23 22:18   </span><a target="_top" href="index_nestest.html">&#x1F3AE; NEStest</a></li><li><span>&apos;19/07/23 22:18   </span><a target="_top" href="index_megamanblue.html">&#x1F3AE; MegaMan in the blue mountains</a></li><li><span>&apos;19/07/23 22:18   </span><a target="_top" href="index_LD36.html">&#x1F3AE; Rune Stacker</a></li><li><span>&apos;19/07/23 22:18   </span><a target="_top" href="index_LD31.html">&#x1F3AE; Doktornix And The Fetch Quest</a></li><li><span>&apos;19/07/23 22:18   </span><a target="_top" href="index_LD29warmup.html">&#x1F3AE; Ludum Dare 29 Warmup</a></li><li><span>&apos;19/07/23 22:18   </span><a target="_top" href="index_LD29.html">&#x1F3AE; Ground control to Major Tomashevsky</a></li><li><span>&apos;19/07/23 22:18   </span><a target="_top" href="index_LD23warmup.html">&#x1F3AE; Ludum Dare 23 Warmup</a></li><li><span>&apos;19/07/23 22:18   </span><a target="_top" href="index_LD23.html">&#x1F3AE; Ludum Dare 23</a></li><li><span>&apos;19/07/23 22:18   </span><a target="_top" href="index_keystone.html">&#x1F3AE; Keystone Kapers for NES</a></li><li><span>&apos;19/07/23 22:18   </span><a target="_top" href="index_gbmine.html">&#x1F3AE; GBMINE</a></li><li><span>&apos;19/07/23 22:18   </span><a target="_top" href="index_choplifter.html">&#x1F3AE; Choplifter</a></li><li><span>&apos;19/07/23 22:18   </span><a target="_top" href="index_breakout.html">&#x1F3AE; 6502 breakout</a></li><li><span>&apos;19/07/23 22:18   </span><a target="_top" href="index_alibaba.html">&#x1F3AE; Ali Baba and the 40 thieves</a></li><li><span>&apos;19/07/23 22:18   </span><a target="_top" href="index_1hgj6.html">&#x1F3AE; 1HGJ6</a></li><li><span>&apos;19/07/23 22:18   </span><a target="_top" href="index_1hgj5.html">&#x1F3AE; 1HGJ5</a></li><li><span>&apos;19/07/23 22:18   </span><a target="_top" href="index_1hgj4.html">&#x1F3AE; 1HGJ4</a></li><li><span>&apos;19/07/23 22:18   </span><a target="_top" href="index_1hgj3.html">&#x1F3AE; 1HGJ3</a></li><li><span>&apos;19/07/23 22:18   </span><a target="_top" href="index_1hg7.html">&#x1F3AE; 1HGJ7</a></li></ul></div>

<h1>Coding a classic MS-DOS fire demo in 256 bytes</h1>

<center><img src="images/fire6.gif"></center><br>

After messing around with x86 Assembly for <a href="index_b17.html" target="_top">the B-17 data decompressor</a>, I had the desire to code one of those classic fire demos -
like <a href="https://fabiensanglard.net/doom_fire_psx/" data-archive="true" target="_top">the PSX Doom fire effect</a><a href="http://web.archive.org/web/20230302181337/https://fabiensanglard.net/doom_fire_psx/" target="_top"><sup>[archive]</sup></a>.<br>
Many years ago, when learning to program, I followed a series of tutorials, in .TXT format, to write one, the tutorials were for x86 Assembly but I coded mine in C with Allegro. Now I have come full circle I guess.<br>

<h2>Making a palette</h2>
First and most important to a good looking fire effect is the palette.<br>
Instead of copying an existing one, I figured mine procedurally. First I grabbed a random fire photo from google.<br>
<!-- <center><img src="images/fire1.jpg" /></center><br> -->
Next I converted this image to 256 colours indexed format, and sorted the colours by luminance, in Aseprite.<br>
<center><img src="images/fire2.png"></center><br>
I then exported the palette, to .PAL format, which looks like this:<br>
<pre>JASC-PAL
0100
256
0 0 0
8 8 0
8 8 24
8 8 32
16 12 16
16 20 16
16 24 24
16 24 32
41 16 8
41 16 24
32 24 24
41 28 24
41 32 24
65 16 32
...</pre><br>
Those values were then passed through a polynomial regression, to create functions from X=[colour index] to Y=[R,G,B].<br>
<center><img src="images/fire3.png"></center><br>
Thus the palette can be encoded in a very efficient format.<br>

<h2>Skeleton of a mode 13h demo</h2>

This is the bare skeleton of a mode 13h .COM MS-DOS program.<br>
<ul>
<li>Set up a double buffer</li>
<li>Enter mode 13h</li>
<li>Upload the palette</li>
<li>Draw a frame to the buffer</li>
<li>Upload the buffer to video memory</li>
<li>Check for a key press, if not pressed, go draw another frame</li>
<li>Before exiting, restore text mode</li>
</ul>
The only noteworthy bit is allocating an extra segment to hold the double buffer in RAM.
There are <a href="https://stackoverflow.com/questions/37509294/how-can-i-get-an-extra-segment-in-dos" target="_top">safe methods with error checking to allocate as much memory is necessary in a COM program</a>, however in a 256-byte demo we just assume at least another 64k are available.<br>

<code class="x86asm" data-hled="true"><span class="hljs-meta">use16</span>
<span class="hljs-meta">segment</span> code 
org <span class="hljs-number">100h</span>
    <span class="hljs-comment">;Find a seg 64k above our own</span>
    <span class="hljs-keyword">mov</span>       <span class="hljs-built_in">bp</span>,<span class="hljs-built_in">cs</span>
    <span class="hljs-keyword">lea</span>       <span class="hljs-built_in">ax</span>,[<span class="hljs-built_in">bp</span>+<span class="hljs-number">4096</span>]
    <span class="hljs-keyword">mov</span>       <span class="hljs-built_in">es</span>,<span class="hljs-built_in">ax</span>
    
    <span class="hljs-comment">;Enter mode 13h</span>
    <span class="hljs-keyword">mov</span>       <span class="hljs-built_in">ax</span>,<span class="hljs-number">13h</span>
    <span class="hljs-keyword">int</span>       <span class="hljs-number">10h</span>
    
    <span class="hljs-comment">;Prepare to palette upload</span>
    <span class="hljs-keyword">mov</span>       <span class="hljs-built_in">dx</span>,<span class="hljs-number">3C8h</span>
    <span class="hljs-keyword">xor</span>       <span class="hljs-built_in">al</span>,<span class="hljs-built_in">al</span>
    <span class="hljs-keyword">out</span>       <span class="hljs-built_in">dx</span>,<span class="hljs-built_in">al</span>
    
    <span class="hljs-keyword">xor</span>       <span class="hljs-built_in">ebx</span>,<span class="hljs-built_in">ebx</span>
<span class="hljs-symbol">    .colloop:</span>
<span class="hljs-meta">        .rgbloop:</span>
            <span class="hljs-comment">;Calculate a R,G,B component in DX</span>
            <span class="hljs-keyword">mov</span>       <span class="hljs-built_in">dx</span>,<span class="hljs-number">3C9h</span>
            <span class="hljs-keyword">out</span>       <span class="hljs-built_in">dx</span>,<span class="hljs-built_in">al</span>         <span class="hljs-comment">;Upload colour component to VGA</span>
            
            <span class="hljs-comment">;Repeat 3 times...</span>
            <span class="hljs-comment">;[...]</span>
        <span class="hljs-comment">;Repeat 256 times...</span>
        <span class="hljs-comment">;[...]</span>
<span class="hljs-symbol">    
    .frame:</span>
    <span class="hljs-comment">;Do something to update the frame buffer here</span>
    <span class="hljs-comment">;[...]</span>
    
    <span class="hljs-comment">;Transfer double buffer segment to VGA memory</span>
    <span class="hljs-keyword">push</span>  <span class="hljs-number">0xA000</span>
    <span class="hljs-keyword">pop</span>       <span class="hljs-built_in">es</span>           <span class="hljs-comment">;ES=VGA</span>
    <span class="hljs-keyword">xor</span>       <span class="hljs-built_in">si</span>,<span class="hljs-built_in">si</span>
    <span class="hljs-keyword">xor</span>       <span class="hljs-built_in">di</span>,<span class="hljs-built_in">di</span>
    <span class="hljs-keyword">mov</span>       <span class="hljs-built_in">cx</span>,<span class="hljs-number">320</span>*<span class="hljs-number">200</span>
    <span class="hljs-keyword">cld</span>
    <span class="hljs-keyword">rep</span>       <span class="hljs-keyword">movsb</span>
    <span class="hljs-keyword">push</span>  <span class="hljs-built_in">ds</span>           
    <span class="hljs-keyword">pop</span>       <span class="hljs-built_in">es</span>           <span class="hljs-comment">;ES=double buffer</span>
    
    <span class="hljs-comment">;Check for keypress</span>
    <span class="hljs-keyword">mov</span>       <span class="hljs-number">ah</span>,<span class="hljs-number">0Bh</span>
    <span class="hljs-keyword">int</span>       <span class="hljs-number">21h</span>
    <span class="hljs-keyword">or</span>        <span class="hljs-built_in">al</span>,<span class="hljs-built_in">al</span>
    <span class="hljs-keyword">jz</span>        .frame
<span class="hljs-symbol">die:</span>
    <span class="hljs-comment">;Restore text mode</span>
    <span class="hljs-keyword">mov</span>       <span class="hljs-built_in">ax</span>,<span class="hljs-number">03h</span>
    <span class="hljs-keyword">int</span>       <span class="hljs-number">10h</span>
    <span class="hljs-comment">;Quit</span>
    <span class="hljs-keyword">ret</span></code><div style="display: none;">use16
segment code 
org 100h
    ;Find a seg 64k above our own
    mov     bp,cs
    lea     ax,[bp+4096]
    mov     es,ax
    
    ;Enter mode 13h
    mov     ax,13h
    int     10h
    
    ;Prepare to palette upload
    mov     dx,3C8h
    xor     al,al
    out     dx,al
    
    xor     ebx,ebx
    .colloop:
        .rgbloop:
            ;Calculate a R,G,B component in DX
            mov     dx,3C9h
            out     dx,al           ;Upload colour component to VGA
            
            ;Repeat 3 times...
            ;[...]
        ;Repeat 256 times...
        ;[...]
    
    .frame:
    ;Do something to update the frame buffer here
    ;[...]
    
    ;Transfer double buffer segment to VGA memory
    push    0xA000
    pop     es          ;ES=VGA
    xor     si,si
    xor     di,di
    mov     cx,320*200
    cld
    rep     movsb
    push    ds          
    pop     es          ;ES=double buffer
    
    ;Check for keypress
    mov     ah,0Bh
    int     21h
    or      al,al
    jz      .frame
die:
    ;Restore text mode
    mov     ax,03h
    int     10h
    ;Quit
    ret</div>
    
<h2>Running fixed point polynomials</h2>

Actually generating the palette is very simple, it is done in 32bit fixed point with 15bits fractional part. More than 15bits would cause overflow.<br>
It can also be done in 16bits fixed point with 11bits fractional part but then the hotter colours look much duller.<br>
The coefficients are stored as such:<br>
<code class="x86asm" data-hled="true"><span class="hljs-symbol">fracbits:</span>        <span class="hljs-built_in">equ</span>      <span class="hljs-number">15</span>
<span class="hljs-comment">;[...]</span>
<span class="hljs-symbol">    palCoeffs:</span>
        <span class="hljs-comment">;    ;A      B       C</span>
        <span class="hljs-built_in">dd</span>   -<span class="hljs-number">31</span>,<span class="hljs-number">15116</span>,    <span class="hljs-number">72876</span>  <span class="hljs-comment">;R</span>
        <span class="hljs-built_in">dd</span>   <span class="hljs-number">27</span>,    <span class="hljs-number">103</span>,   <span class="hljs-number">251127</span> <span class="hljs-comment">;G</span>
        <span class="hljs-built_in">dd</span>   <span class="hljs-number">28</span>,    -<span class="hljs-number">2835</span>, <span class="hljs-number">291624</span> <span class="hljs-comment">;B</span>
<span class="hljs-symbol">    palCoeffsEnd:</span></code><div style="display: none;">fracbits:      equ     15
;[...]
    palCoeffs:
        ;   ;A      B       C
        dd  -31,15116,  72876   ;R
        dd  27, 103,    251127  ;G
        dd  28, -2835,  291624  ;B
    palCoeffsEnd:</div>
And then the full loop is as follows:
<code class="x86asm" data-hled="true">   <span class="hljs-keyword">xor</span>     <span class="hljs-built_in">ebx</span>,<span class="hljs-built_in">ebx</span>
<span class="hljs-symbol">    .colloop:</span>
        <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">si</span>,palCoeffs        <span class="hljs-comment">;Move SI to A for Red</span>
        <span class="hljs-keyword">inc</span>     <span class="hljs-built_in">ebx</span>
<span class="hljs-symbol">            .rgbloop:</span>
            <span class="hljs-comment">;Calc   A*x&#xB2;</span>
            <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">eax</span>,<span class="hljs-built_in">ebx</span>         <span class="hljs-comment">;Load X</span>
            <span class="hljs-keyword">imul</span>    <span class="hljs-built_in">ebx</span>             <span class="hljs-comment">;Calc X^2</span>
            <span class="hljs-keyword">imul</span>    <span class="hljs-built_in">dword</span> [<span class="hljs-built_in">si</span>]      <span class="hljs-comment">;Calc A*X^2</span>
            <span class="hljs-keyword">push</span>    <span class="hljs-built_in">eax</span>             <span class="hljs-comment">;Push result</span>
            
            <span class="hljs-comment">;Calc   B*x</span>
            <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">eax</span>,<span class="hljs-built_in">ebx</span>         <span class="hljs-comment">;Load X</span>
            <span class="hljs-keyword">imul</span>    <span class="hljs-built_in">dword</span> [<span class="hljs-built_in">si</span>+<span class="hljs-number">4</span>]    <span class="hljs-comment">;Calc B*X</span>
            
            <span class="hljs-comment">;Calc A*x&#xB2;+B*x+C</span>
            <span class="hljs-keyword">add</span>     <span class="hljs-built_in">eax</span>,<span class="hljs-built_in">dword</span> [<span class="hljs-built_in">si</span>+<span class="hljs-number">8</span>]<span class="hljs-comment">;Add C</span>
            <span class="hljs-keyword">pop</span>     <span class="hljs-built_in">ecx</span>
            <span class="hljs-keyword">add</span>     <span class="hljs-built_in">eax</span>, <span class="hljs-built_in">ecx</span>        <span class="hljs-comment">;Add A*X^2</span>
            
            <span class="hljs-keyword">shr</span>     <span class="hljs-built_in">eax</span>,fracbits    <span class="hljs-comment">;Discard fractional part of fixed point</span>
            
            <span class="hljs-keyword">add</span>     <span class="hljs-built_in">si</span>,<span class="hljs-number">12</span>           <span class="hljs-comment">;Move SI to next A coeff</span>
            
            <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">dx</span>,<span class="hljs-number">3C9h</span>
            <span class="hljs-keyword">out</span>     <span class="hljs-built_in">dx</span>,<span class="hljs-built_in">al</span>           <span class="hljs-comment">;Upload colour component to VGA</span>
            
            <span class="hljs-keyword">cmp</span>     <span class="hljs-built_in">si</span>,palCoeffsEnd <span class="hljs-comment">;If all coeffs were used then this colour is done</span>
            <span class="hljs-keyword">jb</span>      .rgbloop
        
        <span class="hljs-keyword">or</span>      <span class="hljs-number">bh</span>,<span class="hljs-number">bh</span>
        <span class="hljs-keyword">jz</span>      .colloop</code><div style="display: none;">   xor     ebx,ebx
    .colloop:
        mov     si,palCoeffs        ;Move SI to A for Red
        inc     ebx
            .rgbloop:
            ;Calc   A*x&#xB2;
            mov     eax,ebx         ;Load X
            imul    ebx             ;Calc X^2
            imul    dword [si]      ;Calc A*X^2
            push    eax             ;Push result
            
            ;Calc   B*x
            mov     eax,ebx         ;Load X
            imul    dword [si+4]    ;Calc B*X
            
            ;Calc A*x&#xB2;+B*x+C
            add     eax,dword [si+8];Add C
            pop     ecx
            add     eax, ecx        ;Add A*X^2
            
            shr     eax,fracbits    ;Discard fractional part of fixed point
            
            add     si,12           ;Move SI to next A coeff
            
            mov     dx,3C9h
            out     dx,al           ;Upload colour component to VGA
            
            cmp     si,palCoeffsEnd ;If all coeffs were used then this colour is done
            jb      .rgbloop
        
        or      bh,bh
        jz      .colloop</div>

<h2>Random number generation</h2>

The procedural fire effect requires random numbers in a few different places.<br>
One of the simplest and most compact Random Number Generators is the <a href="https://en.wikipedia.org/wiki/Lehmer_random_number_generator" target="_top">Lehmer RNG</a>.<br>
I picked the coefficient from <a href="https://www.ams.org/journals/mcom/1999-68-225/S0025-5718-99-00996-5/" target="_top">&quot;TABLES OF LINEAR CONGRUENTIAL GENERATORS OF DIFFERENT SIZES AND GOOD LATTICE STRUCTURE&quot;</a>, an article with tables of several possible ones.<br>
Note how I use the segment override, this is because in the rest of the code DS is often pointing to the double buffer.<br>
<code class="x86asm" data-hled="true"><span class="hljs-symbol">randomByte:</span>
    <span class="hljs-comment">;RNG subroutine of Lehmer kind</span>
    <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">eax</span>,<span class="hljs-number">851723965</span>
    <span class="hljs-keyword">mul</span>     <span class="hljs-built_in">dword</span> [<span class="hljs-built_in">cs</span>:rng]
    <span class="hljs-keyword">mov</span>     [<span class="hljs-built_in">cs</span>:rng],<span class="hljs-built_in">eax</span>
    <span class="hljs-keyword">shr</span>     <span class="hljs-built_in">eax</span>,<span class="hljs-number">24</span>
    <span class="hljs-keyword">ret</span>
<span class="hljs-symbol">    
    rng:</span>            <span class="hljs-built_in">dd</span>  <span class="hljs-number">1</span></code><div style="display: none;">randomByte:
    ;RNG subroutine of Lehmer kind
    mov     eax,851723965
    mul     dword [cs:rng]
    mov     [cs:rng],eax
    shr     eax,24
    ret
    
    rng:            dd  1</div>

<h2>The actual fire effect</h2>

The meat of the fire effect is very simple.<br>
The fire is seeded by a line of &quot;ambers&quot;, metaphorically and algorithmically, that is a line of random bright pixels:
<code class="x86asm" data-hled="true">   <span class="hljs-comment">;Fill an invisible line below the screen with random values 128...255</span>
    <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">di</span>,<span class="hljs-number">320</span>*<span class="hljs-number">200</span>
    <span class="hljs-keyword">push</span>    <span class="hljs-built_in">di</span>
    <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">cx</span>,<span class="hljs-number">320</span>
<span class="hljs-symbol">    .fill:</span>
        <span class="hljs-keyword">call</span>    randomByte
        <span class="hljs-keyword">or</span>      <span class="hljs-built_in">al</span>,<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">7</span>
        <span class="hljs-keyword">stosb</span>
        <span class="hljs-keyword">loop</span>    .fill</code><div style="display: none;">   ;Fill an invisible line below the screen with random values 128...255
    mov     di,320*200
    push    di
    mov     cx,320
    .fill:
        call    randomByte
        or      al,1&lt;&lt;7
        stosb
        loop    .fill</div>

Then, for every pixel in the screen; move it up, and cool it a bit. The full algorithm is described in <a href="https://fabiensanglard.net/doom_fire_psx/" data-archive="true" target="_top">Fabien Sanglard&apos;s PSX Doom fire effect page</a><a href="http://web.archive.org/web/20230302181337/https://fabiensanglard.net/doom_fire_psx/" target="_top"><sup>[archive]</sup></a>.<br>
<br>
<code class="x86asm" data-hled="true">   <span class="hljs-keyword">xor</span>     <span class="hljs-built_in">di</span>,<span class="hljs-built_in">di</span>
    <span class="hljs-keyword">pop</span>     <span class="hljs-built_in">cx</span>          <span class="hljs-comment">;CX=320*200</span>
<span class="hljs-symbol">    .pixel:</span>
        <span class="hljs-comment">;Update pixels in a &quot;random&quot; order</span>
        <span class="hljs-keyword">add</span>     <span class="hljs-built_in">di</span>,<span class="hljs-number">51051</span>
        <span class="hljs-keyword">cmp</span>     <span class="hljs-built_in">di</span>,<span class="hljs-number">320</span>*<span class="hljs-number">200</span>
        <span class="hljs-keyword">jnb</span>     .pixel
        
        <span class="hljs-comment">;Find address of a pixel a line below, and maybe 1 pixel to either side</span>
        <span class="hljs-keyword">call</span>    randomByte
        <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">dl</span>,<span class="hljs-number">3</span>
        <span class="hljs-keyword">mul</span>     <span class="hljs-built_in">dl</span>
        <span class="hljs-keyword">shr</span>     <span class="hljs-built_in">ax</span>,<span class="hljs-number">8</span>
        <span class="hljs-keyword">lea</span>     <span class="hljs-built_in">si</span>,[<span class="hljs-built_in">di</span>+<span class="hljs-number">319</span>]
        <span class="hljs-keyword">add</span>     <span class="hljs-built_in">si</span>,<span class="hljs-built_in">ax</span>
        
        <span class="hljs-comment">;Get pixel, cool it down by a random value</span>
        <span class="hljs-keyword">call</span>    randomByte
        <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">dl</span>,<span class="hljs-built_in">al</span>
        <span class="hljs-keyword">lodsb</span>
        <span class="hljs-keyword">and</span>     <span class="hljs-built_in">dx</span>,<span class="hljs-number">15</span>
        <span class="hljs-keyword">sub</span>     <span class="hljs-built_in">dx</span>,<span class="hljs-number">4</span>
        <span class="hljs-keyword">sub</span>     <span class="hljs-built_in">ax</span>,<span class="hljs-built_in">dx</span>
        <span class="hljs-keyword">jns</span>     .notneg
            <span class="hljs-keyword">xor</span>     <span class="hljs-built_in">al</span>,<span class="hljs-built_in">al</span>
<span class="hljs-symbol">        .notneg:</span>
        
        <span class="hljs-comment">;Store new pixel</span>
        <span class="hljs-keyword">stosb</span>
        <span class="hljs-keyword">loop</span>    .pixel</code><div style="display: none;">   xor     di,di
    pop     cx          ;CX=320*200
    .pixel:
        ;Update pixels in a &quot;random&quot; order
        add     di,51051
        cmp     di,320*200
        jnb     .pixel
        
        ;Find address of a pixel a line below, and maybe 1 pixel to either side
        call    randomByte
        mov     dl,3
        mul     dl
        shr     ax,8
        lea     si,[di+319]
        add     si,ax
        
        ;Get pixel, cool it down by a random value
        call    randomByte
        mov     dl,al
        lodsb
        and     dx,15
        sub     dx,4
        sub     ax,dx
        jns     .notneg
            xor     al,al
        .notneg:
        
        ;Store new pixel
        stosb
        loop    .pixel</div><br>
I will only add that the order of pixel updates matters a lot. If one removes the bit which adds 51051 (3 &#xD7; 11 &#xD7; 7 &#xD7; 13 &#xD7; 17 = coprime both to 320 and to 200), the result is a very patterned, unnatural fire:<br>
<center><img src="images/fire5.gif"></center><br>

<h2>The result</h2>

The final result is 234 bytes - under the 256 byte target - and even 2152 bytes less than the source code.<br>
The GIFs dont do it justice - you can download source and COM file here:
<center><a href="files/firedemo.zip" target="_top"><table><tbody><tr><td><img src="images/dosrul__.gif"></td><td>DOWNLOAD XTRACT UTILITY</td></tr></tbody></table></a></center><br>

</body></html>