<!DOCTYPE html><html><head data-created="2021-07-24T21:25:15.675Z" data-modified="2021-07-24T21:25:13.538Z"><meta charset="UTF-8"><meta charset="UTF8"><link rel="stylesheet" href="hlstyles/default.css"><link rel="stylesheet" href="motherfucker.css"></head><body data-title="OPL3 MIDI player"><div class="article-index"><ul data-type="pages_index"><li><span>&apos;23/05/14 20:37   </span><a target="_top" href="index_firedemo.html">256-byte x86 fire demo</a></li><li><span>&apos;23/04/29 22:19   </span><a target="_top" href="index_b17.html">Reverse engineering a DOS game B17 Flying Fortress</a></li><li><span>&apos;22/01/03 23:33   </span><a target="_top" href="index_c64floats.html">C++ Commodore 64 floating point library</a></li><li><span>&apos;21/07/24 21:25   </span><a target="_top" href="index_OPL.html">OPL3 MIDI player</a></li><li><span>&apos;20/12/06 22:27   </span><a target="_top" href="index_gifcap.html">gifcap library</a></li><li><span>&apos;20/08/01 21:53   </span><a target="_top" href="index_doomloader.html">Doom level loader</a></li><li><span>&apos;19/11/19 06:06   </span><a target="_top" href="index_nesem3.html">NES Emulation Saga Part III</a></li><li><span>&apos;19/11/19 06:06   </span><a target="_top" href="index_nesem2.html">NES Emulation Saga Part II</a></li><li><span>&apos;19/11/19 06:06   </span><a target="_top" href="index_nesem1.html">NES Emulation Saga Part I</a></li><li><span>&apos;19/10/31 02:37   </span><a target="_top" href="index_kym.html">&#x1F3AE; Kori Yogan Mushi</a></li><li><span>&apos;19/08/03 20:43   </span><a target="_top" href="index_bespoke.html">&#x1F3AE; Bespoke Terror</a></li><li><span>&apos;19/08/03 20:32   </span><a target="_top" href="index_1hgj8.html">&#x1F3AE; Conker&apos;s BFD for Nintendo 486</a></li><li><span>&apos;19/07/23 22:18   </span><a target="_top" href="index_trog.html">&#x1F3AE; TROG</a></li><li><span>&apos;19/07/23 22:18   </span><a target="_top" href="index_stacker.html">&#x1F3AE; TTY Stacker</a></li><li><span>&apos;19/07/23 22:18   </span><a target="_top" href="index_snake.html">&#x1F3AE; Snake</a></li><li><span>&apos;19/07/23 22:18   </span><a target="_top" href="index_sm64.html">&#x1F3AE; SM64 HTML5</a></li><li><span>&apos;19/07/23 22:18   </span><a target="_top" href="index_ronaldo.html">&#x1F3AE; 3D Ronaldo Football</a></li><li><span>&apos;19/07/23 22:18   </span><a target="_top" href="index_roguelike.html">&#x1F3AE; Batch Roguelike</a></li><li><span>&apos;19/07/23 22:18   </span><a target="_top" href="index_prototype.html">&#x1F3AE; Prototype</a></li><li><span>&apos;19/07/23 22:18   </span><a target="_top" href="index_nestest.html">&#x1F3AE; NEStest</a></li><li><span>&apos;19/07/23 22:18   </span><a target="_top" href="index_megamanblue.html">&#x1F3AE; MegaMan in the blue mountains</a></li><li><span>&apos;19/07/23 22:18   </span><a target="_top" href="index_LD36.html">&#x1F3AE; Rune Stacker</a></li><li><span>&apos;19/07/23 22:18   </span><a target="_top" href="index_LD31.html">&#x1F3AE; Doktornix And The Fetch Quest</a></li><li><span>&apos;19/07/23 22:18   </span><a target="_top" href="index_LD29warmup.html">&#x1F3AE; Ludum Dare 29 Warmup</a></li><li><span>&apos;19/07/23 22:18   </span><a target="_top" href="index_LD29.html">&#x1F3AE; Ground control to Major Tomashevsky</a></li><li><span>&apos;19/07/23 22:18   </span><a target="_top" href="index_LD23warmup.html">&#x1F3AE; Ludum Dare 23 Warmup</a></li><li><span>&apos;19/07/23 22:18   </span><a target="_top" href="index_LD23.html">&#x1F3AE; Ludum Dare 23</a></li><li><span>&apos;19/07/23 22:18   </span><a target="_top" href="index_keystone.html">&#x1F3AE; Keystone Kapers for NES</a></li><li><span>&apos;19/07/23 22:18   </span><a target="_top" href="index_gbmine.html">&#x1F3AE; GBMINE</a></li><li><span>&apos;19/07/23 22:18   </span><a target="_top" href="index_choplifter.html">&#x1F3AE; Choplifter</a></li><li><span>&apos;19/07/23 22:18   </span><a target="_top" href="index_breakout.html">&#x1F3AE; 6502 breakout</a></li><li><span>&apos;19/07/23 22:18   </span><a target="_top" href="index_alibaba.html">&#x1F3AE; Ali Baba and the 40 thieves</a></li><li><span>&apos;19/07/23 22:18   </span><a target="_top" href="index_1hgj6.html">&#x1F3AE; 1HGJ6</a></li><li><span>&apos;19/07/23 22:18   </span><a target="_top" href="index_1hgj5.html">&#x1F3AE; 1HGJ5</a></li><li><span>&apos;19/07/23 22:18   </span><a target="_top" href="index_1hgj4.html">&#x1F3AE; 1HGJ4</a></li><li><span>&apos;19/07/23 22:18   </span><a target="_top" href="index_1hgj3.html">&#x1F3AE; 1HGJ3</a></li><li><span>&apos;19/07/23 22:18   </span><a target="_top" href="index_1hg7.html">&#x1F3AE; 1HGJ7</a></li></ul></div>

<h1 id="kdrnic-s-opl3-midi-player">OPL3 MIDI player</h1>

<video controls height="256">
    <source src="files/opl.webm" type="video/mp4">
    Sorry, your browser sucks balls.
</video><br>

This project is <a href="https://github.com/kdrnic/al4_ymfm_midi" target="_top">hosted at github</a>.

<p>This is a library which uses <a href="https://github.com/aaronsgiles/ymfm/" target="_top">YMFM</a> to emulate the OPL3 in a Sound Blaster 16, while using a modified version of the Allegro 4 Sound Blaster 16 MIDI driver for MS-DOS to generate the register writes.</p>
<p>The Allegro 4 MIDI playing code was heavily  modified to be completely independent of Allegro 4 and no longer contains platform specific code.</p>
<p>Much of the YMFM &quot;frontend&quot; code was taken from <a href="https://github.com/aaronsgiles/ymfm/blob/ef21f08a16f44b005c9ace5f8f44ae6f95dbf3f0/examples/vgmrender/vgmrender.cpp" target="_top">vgmrender.cpp</a>.</p>
<p>It supports IBK patch files created by <a href="https://github.com/Wohlstand/OPL3BankEditor" target="_top">OPL3BankEditor</a> through the kdr_load_ibk function.</p>
<h2 id="usage">Usage</h2>
<p>A example of use is provided in main.c.</p>
<p>It uses Allegro 4 for user interface, but can be easily modified to be an Allegro 4 independent text-only MIDI to WAV renderer.</p>
<p>Additionally, a minimal sample is shown below. You might check out Allegro 4 documentation to get information on additional routines.</p>
<pre><code class="c" data-hled="true"><span class="hljs-keyword">uint16_t</span> *get_audio_stream_buffer(...)
{
   <span class="hljs-comment">//Returns a buffer to be filled...</span>
}

<span class="hljs-keyword">void</span> *ymfm = ymfm_init(YMFM_SB16_OPL_CLOCK_RATE, sampling_rate, stereo);
KDR_MIDI_CTX *ctx = kdr_create_midi_ctx();
kdr_install_driver(ctx, &amp;kdr_midi_opl3, ymfm);
KDR_MIDI *mid = kdr_load_midi(ctx, midi_fn);
kdr_play_midi(ctx, mid, <span class="hljs-number">0</span>);
<span class="hljs-keyword">while</span>(...){
   <span class="hljs-keyword">uint16_t</span> *audio_buf = get_audio_stream_buffer(...);
   ymfm_generate(ymfm, audio_buf, num_samples);
   kdr_update_midi(ctx, num_samples, sampling_rate);
}
kdr_destroy_midi(ctx, mid);
ymfm_destroy(ymfm);
kdr_destroy_midi_ctx(ctx);</code><div style="display: none;">uint16_t *get_audio_stream_buffer(...)
{
   //Returns a buffer to be filled...
}

void *ymfm = ymfm_init(YMFM_SB16_OPL_CLOCK_RATE, sampling_rate, stereo);
KDR_MIDI_CTX *ctx = kdr_create_midi_ctx();
kdr_install_driver(ctx, &amp;kdr_midi_opl3, ymfm);
KDR_MIDI *mid = kdr_load_midi(ctx, midi_fn);
kdr_play_midi(ctx, mid, 0);
while(...){
   uint16_t *audio_buf = get_audio_stream_buffer(...);
   ymfm_generate(ymfm, audio_buf, num_samples);
   kdr_update_midi(ctx, num_samples, sampling_rate);
}
kdr_destroy_midi(ctx, mid);
ymfm_destroy(ymfm);
kdr_destroy_midi_ctx(ctx);</div></pre>
<h2 id="solved-issues">Solved issues</h2>
<h3 id="interrupts">Interrupts</h3>
<p>The original DOS code would use a <a href="https://github.com/msikma/allegro-4.2.2-xc/blob/ecd87af7f43f9e08f49acc78f4901c39221dbab5/src/midi.c#L897" target="_top">midi_player routine</a> triggered regularly by a PIT timer interrupt to directly call other routines such as <a href="https://github.com/kdrnic/al4_ymfm_midi/blob/c784c03fee79bcf291c2b275743ef059be8392f5/src/kdr_adlib.c#L525" target="_top">a key_on handler</a>.</p>
<p>Meanwhile, the emulator needs to run as it is triggered by an available audio buffer. Thus, I modified the code from being interrupt driven to one driven by a call to a user accessible update routine.</p>
<h3 id="deglobalization">Deglobalization</h3>
<p>The original Allegro code was heavy on its use of globals. I made it so all the former globals now rest in a KDR_MIDI_CTX structure.</p>
<h3 id="downsampling">Downsampling</h3>
<p>There exists <a href="https://github.com/aaronsgiles/ymfm/blob/ef21f08a16f44b005c9ace5f8f44ae6f95dbf3f0/README.md#clocking" target="_top">an issue with sampling rate mentioned in YMFM readme</a> which I don&apos;t entirely understand (i.e. I don&apos;t understand whether running at the lower rate will be &quot;wrong&quot;, like missing register writes etc, or just aliased). Seems the output rate for the OPL3 on a Sound Blaster 16 as calculated by sample_rate() method is 49715 Hz. I have added downsampling with <a href="https://github.com/minorninth/libresample" target="_top">libresample</a>. I&apos;ve checked spectrograms and this provides nice, unaliased sound.</p>
<h3 id="c-to-c-hack">C++ to C hack</h3>
<p>The build is set up so the YMFM side can be built with g++, but then the program can be linked with gcc.</p>
<p>This is done through some gcc flags and providing a cxa_pure_virtual and operator delete for void pointers.</p>


</body></html>